name: local-gateway

services:
  localstack:
    container_name: gateway-localstack
    image: localstack/localstack:latest
    ports:
      - "${LOCALSTACK_PORT}:4566"
    environment:
      - SERVICES=${LOCALSTACK_SERVICES}
      - DEBUG=${LOCALSTACK_DEBUG}
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('${AWS_ENDPOINT_URL}/_localstack/health').read()",
        ]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 10s
    networks:
      - local-gateway

  dynamodb-admin:
    container_name: gateway-dynamodb-admin
    image: aaronshaf/dynamodb-admin:latest
    depends_on:
      localstack:
        condition: service_healthy
    ports:
      - "${DYNAMODB_ADMIN_PORT}:8001"
    environment:
      # aaronshaf/dynamodb-admin イメージ が 内部的に使用している環境変数
      - DYNAMO_ENDPOINT=${AWS_ENDPOINT_URL}
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    networks:
      - local-gateway

  awscli:
    container_name: gateway-awscli
    image: amazon/aws-cli:latest
    depends_on:
      terraform:
        condition: service_completed_successfully
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - AWS_ENDPOINT_URL=${AWS_ENDPOINT_URL}
      - LOCALSTACK_PORT=${LOCALSTACK_PORT}
    volumes:
      - ./init:/init:ro
    entrypoint: ["/bin/sh", "-lc"]
    command:
      [
        "/init/seed_dynamodb.sh && sleep infinity",
      ]
    networks:
      - local-gateway

  go-dev:
    platform: linux/arm64
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILDPLATFORM: linux/arm64
        TARGETPLATFORM: linux/arm64
    container_name: gateway-go-dev
    depends_on:
      localstack:
        condition: service_started
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - AWS_ENDPOINT_URL=${AWS_ENDPOINT_URL}
    volumes:
      - .:/src:cached
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /src
    tty: true
    networks:
      - local-gateway

  terraform:
    container_name: gateway-terraform
    image: hashicorp/terraform:latest
    depends_on:
      localstack:
        condition: service_healthy
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
    volumes:
      - ./terraform:/terraform
      - ./lambda:/lambda:ro
    working_dir: /terraform/local
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "==> Cleaning old Terraform state files"
        rm -f terraform.tfstate* .terraform.lock.hcl
        echo "==> Initializing Terraform"
        terraform init
        echo "==> Applying Terraform configuration"
        terraform apply -auto-approve
    networks:
      - local-gateway

  backend-server:
    container_name: gateway-backend-server
    build:
      context: ./backend-server
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - SERVICE_NAME=backend-api
      - PORT=8080
    networks:
      - local-gateway
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  local-gateway:
    driver: bridge
